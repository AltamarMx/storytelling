---
title: "Comunidad HackODS"
format:
  dashboard:
    theme:
      - cosmo
      - custom.scss
    css: style.css
    orientation: rows
    scrolling: true
    logo: logo.png
    nav-buttons:
      - icon: github
        href: https://github.com/hackods
jupyter: python3
---

```{python}
#| echo: false
#| output: false

# ============================================================
# SETUP: Paleta, datos simulados y funci√≥n de estilo
# ============================================================
import plotly.graph_objects as go
import plotly.express as px
from plotly.subplots import make_subplots
import pandas as pd
import numpy as np

# --- Paleta HackODS (colores ODS) ---
BLACK = "#1a1a1a"
WHITE = "#ffffff"
LIGHT_GRAY = "#f9fafb"
MEDIUM_GRAY = "#6b7280"
DARK_GRAY = "#1f2937"
FONT = "Inter, system-ui, sans-serif"
TITLE_FONT = "Space Grotesk, system-ui, sans-serif"

# Colores principales tomados de los ODS
ODS_BLUE = "#0a97d9"      # Azul ODS (rueda)
ODS_GREEN = "#4CA146"      # ODS 3 - verde
ODS_RED = "#E5233D"        # ODS 1 - rojo
ODS_ORANGE = "#F26A2D"     # ODS 9 - naranja
ODS_YELLOW = "#FBC412"     # ODS 7 - amarillo
ODS_PINK = "#E01483"       # ODS 10 - rosa
ODS_TEAL = "#27BFE6"       # ODS 6 - cyan
ODS_DARK_BLUE = "#126A9F"  # ODS 16 - azul oscuro

# Paleta categorica multicolor ODS
HACKODS_CAT = [ODS_BLUE, ODS_RED, ODS_GREEN, ODS_ORANGE, ODS_PINK, ODS_YELLOW, ODS_TEAL, ODS_DARK_BLUE, "#A31C44", "#59BA48"]
# Paleta secuencial azul ODS
HACKODS_SEQ = ["#e0f4fd", "#b3e5fc", "#7dd3f7", "#4fc3f7", "#0a97d9", "#0277bd", "#01579b"]

LEVEL_COLORS = {
    "Nunca lo use": "#e5e7eb",
    "Principiante": "#7dd3f7",
    "Intermedio": "#0a97d9",
    "Avanzado": "#01579b",
}

SDG_COLORS = {
    1: "#E5233D", 2: "#DDA73A", 3: "#4CA146", 4: "#C5192D",
    5: "#EF402C", 6: "#27BFE6", 7: "#FBC412", 8: "#A31C44",
    9: "#F26A2D", 10: "#E01483", 11: "#F89D2A", 12: "#BF8D2C",
    13: "#407F46", 14: "#1F97D4", 15: "#59BA48", 16: "#126A9F",
    17: "#13496B",
}

SDG_NAMES = {
    1: "Fin de la pobreza", 2: "Hambre cero", 3: "Salud y bienestar",
    4: "Educacion de calidad", 5: "Igualdad de genero", 6: "Agua limpia",
    7: "Energia asequible", 8: "Trabajo decente", 9: "Industria e innovacion",
    10: "Reduccion de desigualdades", 11: "Ciudades sostenibles",
    12: "Produccion responsable", 13: "Accion por el clima",
    14: "Vida submarina", 15: "Vida de ecosistemas terrestres",
    16: "Paz, justicia e instituciones", 17: "Alianzas para los objetivos",
}


def hackods_fig(fig, title="", height=None):
    """Aplica el estilo HackODS a cualquier figura Plotly."""
    layout_args = dict(
        title=dict(
            text=f"<b>{title}</b>" if title else "",
            font=dict(family=TITLE_FONT, size=16, color=BLACK),
            x=0.5, xanchor="center",
        ),
        paper_bgcolor=WHITE,
        plot_bgcolor=WHITE,
        font=dict(family=FONT, size=12, color=DARK_GRAY),
        margin=dict(l=20, r=20, t=50, b=20),
        hoverlabel=dict(
            bgcolor=BLACK, font_size=12, font_family=FONT,
            font_color=WHITE, bordercolor=ODS_BLUE,
        ),
    )
    if height:
        layout_args["height"] = height
    fig.update_layout(**layout_args)
    return fig


# ============================================================
# DATOS SIMULADOS ‚Äî 150 participantes, 50 equipos
# ============================================================
np.random.seed(42)
N = 150
TEAMS = 50

# --- Identidad de genero ---
genero_opciones = ["Mujer", "Hombre", "No binarie", "Prefiero no decir"]
genero_pesos = [0.44, 0.40, 0.10, 0.06]
generos = np.random.choice(genero_opciones, size=N, p=genero_pesos)

# --- Edad ---
edades = np.random.normal(loc=23, scale=3.5, size=N).clip(18, 40).astype(int)

# --- Estado ---
estados_opciones = [
    "CDMX", "Estado de Mexico", "Jalisco", "Nuevo Leon", "Puebla",
    "Queretaro", "Veracruz", "Guanajuato", "Michoacan", "Oaxaca",
    "Yucatan", "Chiapas", "Sonora", "Morelos", "Hidalgo", "Otro"
]
estados_pesos = [
    0.25, 0.12, 0.10, 0.08, 0.07, 0.06, 0.05, 0.04,
    0.04, 0.04, 0.03, 0.03, 0.02, 0.02, 0.02, 0.03
]
estados = np.random.choice(estados_opciones, size=N, p=estados_pesos)

# --- Area de conocimiento ---
area_opciones = ["Ingenierias", "Ciencias", "Ciencias Sociales", "Humanidades", "Artes", "Salud"]
area_pesos = [0.30, 0.25, 0.18, 0.12, 0.08, 0.07]
areas = np.random.choice(area_opciones, size=N, p=area_pesos)

# --- Nivel de herramientas ---
niveles = ["Nunca lo use", "Principiante", "Intermedio", "Avanzado"]

python_nivel = np.random.choice(niveles, size=N, p=[0.08, 0.25, 0.42, 0.25])
quarto_nivel = np.random.choice(niveles, size=N, p=[0.35, 0.30, 0.25, 0.10])
github_nivel = np.random.choice(niveles, size=N, p=[0.20, 0.32, 0.30, 0.18])

# --- ODS favorito ---
ods_favoritos = np.random.choice(list(range(1, 18)), size=N, p=[
    0.03, 0.04, 0.06, 0.08, 0.05, 0.07, 0.06, 0.03,
    0.04, 0.03, 0.05, 0.05, 0.15, 0.08, 0.07, 0.04, 0.07
])

# --- Habitos sostenibles ---
habitos_lista = [
    "Recicla", "Usa transporte publico", "Reduce plastico",
    "Composta", "Ahorra energia", "Consume local", "Usa bici",
    "Dieta plant-based", "Ahorra agua"
]
habitos_por_persona = [np.random.choice(habitos_lista, size=np.random.randint(1, 5), replace=False).tolist() for _ in range(N)]

# --- Conciencia de huella de carbono ---
carbono_opciones = [
    "Si, calculo mi huella", "Tengo una idea general",
    "He escuchado del tema", "No se que es"
]
carbono = np.random.choice(carbono_opciones, size=N, p=[0.12, 0.35, 0.38, 0.15])

# --- Acciones climaticas ---
acciones_opciones = [
    "Marcha/protesta", "Firma peticiones", "Educa a otres",
    "Proyecto comunitario", "Contenido en redes", "Voluntariado",
    "Donaciones", "Ninguna aun"
]
acciones = np.random.choice(acciones_opciones, size=N, p=[0.08, 0.15, 0.18, 0.12, 0.20, 0.10, 0.05, 0.12])

# --- Datos fun ---
genero_musical_opciones = [
    "Pop", "Rock", "Reggaeton", "Lo-fi/Chill", "Electronica",
    "Hip-hop", "Clasica", "Cumbia", "K-pop", "Otro"
]
genero_musical = np.random.choice(genero_musical_opciones, size=N, p=[
    0.15, 0.12, 0.14, 0.13, 0.10, 0.08, 0.05, 0.08, 0.10, 0.05
])

animal_opciones = ["Ajolote", "Perezoso", "Buho", "Gato", "Capibara", "Loro", "Pinguino", "Perro golden"]
animal_emojis = {
    "Ajolote": "Ajolote ü¶é", "Perezoso": "Perezoso ü¶•", "Buho": "Buho ü¶â",
    "Gato": "Gato üê±", "Capibara": "Capibara ü¶´", "Loro": "Loro ü¶ú",
    "Pinguino": "Pinguino üêß", "Perro golden": "Perro golden üêï"
}
animales = np.random.choice(animal_opciones, size=N, p=[0.18, 0.15, 0.14, 0.12, 0.12, 0.10, 0.10, 0.09])

snack_opciones = ["Pizza", "Cafe", "Galletas", "Fruta", "Papas/Chips", "Tacos", "Chocolate", "Gomitas", "Nada", "Otro"]
snacks = np.random.choice(snack_opciones, size=N, p=[0.18, 0.15, 0.10, 0.08, 0.12, 0.10, 0.12, 0.07, 0.04, 0.04])

horas_sueno = np.random.normal(loc=4.5, scale=1.5, size=N).clip(0, 9).round(1)

superpoder_opciones = [
    "No dormir nunca", "Debuggear con la mente", "Wifi infinito",
    "Entender cualquier dataset", "Hablar todos los idiomas", "Teletransportarse"
]
superpoderes = np.random.choice(superpoder_opciones, size=N, p=[0.25, 0.20, 0.18, 0.15, 0.12, 0.10])

# --- DataFrame maestro ---
equipos = [f"Equipo {i // 3 + 1}" for i in range(N)]
df = pd.DataFrame({
    "id": range(1, N + 1),
    "equipo": equipos,
    "genero": generos,
    "edad": edades,
    "estado": estados,
    "area": areas,
    "python_nivel": python_nivel,
    "quarto_nivel": quarto_nivel,
    "github_nivel": github_nivel,
    "ods_favorito": ods_favoritos,
    "conciencia_carbono": carbono,
    "accion_climatica": acciones,
    "genero_musical": genero_musical,
    "animal_espiritu": animales,
    "snack": snacks,
    "horas_sueno": horas_sueno,
    "superpoder": superpoderes,
})

# Conteos utiles
n_estados = df["estado"].nunique()
n_areas = df["area"].nunique()
```

# Panorama General {scrolling="false"}

## Row {.tabset .fill}

### Totales

```{python}
#| content: valuebox
#| title: "Participantes"
dict(icon="people-fill", color="#0a97d9", value=N)
```

```{python}
#| content: valuebox
#| title: "Equipos"
dict(icon="collection-fill", color="#4CA146", value=TEAMS)
```

```{python}
#| content: valuebox
#| title: "Estados"
dict(icon="geo-alt-fill", color="#E5233D", value=f"{n_estados}")
```

```{python}
#| content: valuebox
#| title: "Areas de conocimiento"
dict(icon="mortarboard-fill", color="#F26A2D", value=n_areas)
```

### Identidad de genero

```{python}
#| title: "Identidad de genero"
gen_colors_map = {"Mujer": ODS_BLUE, "Hombre": ODS_GREEN, "No binarie": ODS_ORANGE, "Prefiero no decir": MEDIUM_GRAY}
gen_order = ["Mujer", "Hombre", "No binarie", "Prefiero no decir"]
gen_counts = df["genero"].value_counts()

traces = []
for gen in gen_order:
    count = gen_counts.get(gen, 0)
    pct = count / N * 100
    traces.append(go.Bar(
        y=["Identidad de genero"],
        x=[pct],
        name=gen,
        orientation="h",
        marker_color=gen_colors_map[gen],
        text=[f"{gen}: {count} ({pct:.0f}%)"],
        textposition="inside",
        textfont=dict(color=WHITE, size=13),
        hovertemplate=f"{gen}: {count} personas ({pct:.0f}%)<extra></extra>",
    ))
fig = go.Figure(data=traces, layout=dict(
    barmode="stack",
    legend=dict(orientation="h", y=-0.3, x=0.5, xanchor="center"),
    yaxis=dict(showticklabels=False, showgrid=False),
    xaxis=dict(showgrid=False, showticklabels=False, range=[0, 100]),
))
hackods_fig(fig, "Identidad de genero")
```

### Distribucion de edad

```{python}
#| title: "Distribucion de edad"
fig = go.Figure(go.Histogram(
    x=df["edad"],
    nbinsx=12,
    marker_color=ODS_BLUE,
    opacity=0.85,
    hovertemplate="Edad %{x}: %{y} personas<extra></extra>",
))
mean_age = df["edad"].mean()
_ = fig.add_vline(x=mean_age, line_dash="dash", line_color=BLACK, line_width=2)
_ = fig.add_annotation(text=f"Promedio: {mean_age:.0f} anios", x=mean_age + 1.5, y=0.95,
                   yref="paper", showarrow=False,
                   font=dict(size=13, color=BLACK, family=TITLE_FONT))
_ = fig.update_layout(bargap=0.15)
_ = fig.update_xaxes(title_text="Edad", showgrid=False)
_ = fig.update_yaxes(title_text="Participantes", showgrid=True, gridcolor="#f3f4f6")
hackods_fig(fig)
```

### Areas de conocimiento

```{python}
#| title: "Areas de conocimiento"
area_counts = df["area"].value_counts().sort_values()
colors_area = [ODS_BLUE] * len(area_counts)
colors_area[-1] = ODS_RED

fig = go.Figure(go.Bar(
    y=area_counts.index,
    x=area_counts.values,
    orientation="h",
    marker_color=colors_area,
    text=[f"{v} ({v/N*100:.0f}%)" for v in area_counts.values],
    textposition="outside",
    hovertemplate="%{y}: %{x} personas<extra></extra>",
))
_ = fig.update_xaxes(showgrid=False, showticklabels=False)
_ = fig.update_yaxes(showgrid=False)
hackods_fig(fig, "Areas de conocimiento")
```

# Quienes somos?

## Row {.tabset .fill}

### Totales

```{python}
#| content: valuebox
#| title: "Edad promedio"
dict(icon="calendar-heart", color="#0a97d9", value=f"{df['edad'].mean():.0f} anios")
```

```{python}
#| content: valuebox
#| title: "Estado #1"
dict(icon="geo-alt-fill", color="#4CA146", value=df["estado"].value_counts().index[0])
```

```{python}
#| content: valuebox
#| title: "Area #1"
dict(icon="book-fill", color="#E5233D", value=df["area"].value_counts().index[0])
```

```{python}
#| content: valuebox
#| title: "Mujeres"
pct_mujeres = (df["genero"] == "Mujer").mean() * 100
dict(icon="person-fill", color="#F26A2D", value=f"{pct_mujeres:.0f}%")
```

### De que estado venimos?

```{python}
#| title: "De que estado venimos?"
estado_counts = df["estado"].value_counts().reset_index()
estado_counts.columns = ["estado", "count"]
fig = px.treemap(
    estado_counts, path=["estado"], values="count",
    color_discrete_sequence=HACKODS_CAT,
)
_ = fig.update_traces(
    textinfo="label+value",
    hovertemplate="<b>%{label}</b><br>%{value} personas<extra></extra>",
)
hackods_fig(fig, "De que estado venimos?")
```

### Genero por area de conocimiento

```{python}
#| title: "Genero por area de conocimiento"
cross = pd.crosstab(df["area"], df["genero"])
cross = cross.reindex(columns=genero_opciones, fill_value=0)
cross_pct = cross.div(cross.sum(axis=1), axis=0) * 100
area_order = cross.sum(axis=1).sort_values(ascending=True).index

gen_colors = {
    "Mujer": ODS_BLUE, "Hombre": ODS_GREEN,
    "No binarie": ODS_ORANGE, "Prefiero no decir": MEDIUM_GRAY
}

traces = []
for gen in genero_opciones:
    if gen in cross_pct.columns:
        counts = cross.loc[area_order, gen]
        pcts = cross_pct.loc[area_order, gen]
        traces.append(go.Bar(
            y=area_order,
            x=pcts,
            name=gen,
            orientation="h",
            marker_color=gen_colors[gen],
            text=[f"{p:.0f}%" for p in pcts],
            textposition="inside",
            textfont=dict(color=WHITE, size=12),
            hovertemplate=f"{gen}: " + "%{x:.0f}% (%{customdata} personas)<extra></extra>",
            customdata=counts,
        ))
fig = go.Figure(data=traces)
_ = fig.update_layout(barmode="stack", legend=dict(orientation="h", y=-0.15, x=0.5, xanchor="center"))
_ = fig.update_xaxes(showgrid=False, showticklabels=False, range=[0, 100])
_ = fig.update_yaxes(showgrid=False)
hackods_fig(fig)
```

### Mapa geografico

```{python}
#| title: "Mapa geografico"
import json
import urllib.request
import unicodedata

def _normalize(s):
    nfkd = unicodedata.normalize("NFKD", s)
    return "".join(c for c in nfkd if not unicodedata.combining(c)).lower().strip()

# GeoJSON de estados mexicanos
_mx_url = "https://raw.githubusercontent.com/angelnmara/geojson/master/mexicoHigh.json"
with urllib.request.urlopen(_mx_url) as _resp:
    mx_geo = json.loads(_resp.read())

# Lookup normalizado de nombres del GeoJSON
_geo_lookup = {}
for _feat in mx_geo["features"]:
    _name = _feat["properties"]["name"]
    _geo_lookup[_normalize(_name)] = _name

# Mapeo de nuestros nombres a los del GeoJSON
_manual = {"cdmx": "ciudad de mexico", "estado de mexico": "mexico"}

def _match(our_name):
    key = _normalize(our_name)
    key = _manual.get(key, key)
    if key in _geo_lookup:
        return _geo_lookup[key]
    for gk, gv in _geo_lookup.items():
        if key in gk or gk.startswith(key):
            return gv
    return None

# Conteos por estado con nombre GeoJSON
estado_map = df["estado"].value_counts().reset_index()
estado_map.columns = ["estado", "count"]
estado_map["geo_name"] = estado_map["estado"].map(_match)

# Todos los estados (0 participantes por defecto)
all_geo_names = [f["properties"]["name"] for f in mx_geo["features"]]
all_states = pd.DataFrame({"geo_name": all_geo_names})
all_states = all_states.merge(
    estado_map[["geo_name", "count"]].dropna(subset=["geo_name"]),
    on="geo_name", how="left",
).fillna(0)

fig = go.Figure(go.Choropleth(
    geojson=mx_geo,
    locations=all_states["geo_name"],
    z=all_states["count"],
    featureidkey="properties.name",
    colorscale=HACKODS_SEQ,
    marker_line_color="#9ca3af",
    marker_line_width=1,
    showscale=True,
    colorbar=dict(title="Participantes", thickness=15, len=0.5),
    hovertemplate="<b>%{location}</b><br>%{z:.0f} personas<extra></extra>",
))
fig.update_geos(
    fitbounds="geojson",
    visible=False,
    bgcolor=WHITE,
)
hackods_fig(fig, "De donde venimos?")
```

# Nuestras herramientas

## Row {.tabset .fill}

### Totales

```{python}
#| content: valuebox
#| title: "Saben Python"
n_py = (df["python_nivel"] != "Nunca lo use").sum()
dict(icon="filetype-py", color="#0a97d9", value=f"{n_py} de {N}")
```

```{python}
#| content: valuebox
#| title: "Saben Quarto"
n_q = (df["quarto_nivel"] != "Nunca lo use").sum()
dict(icon="file-earmark-code", color="#4CA146", value=f"{n_q} de {N}")
```

```{python}
#| content: valuebox
#| title: "Saben GitHub Pages"
n_gh = (df["github_nivel"] != "Nunca lo use").sum()
dict(icon="github", color="#E5233D", value=f"{n_gh} de {N}")
```

### Python

```{python}
#| title: "Nivel de Python"
nivel_order = ["Nunca lo use", "Principiante", "Intermedio", "Avanzado"]
py_counts = df["python_nivel"].value_counts().reindex(nivel_order, fill_value=0)
py_pcts = py_counts / N * 100

fig = go.Figure(go.Bar(
    y=["Python"],
    x=[py_pcts[n] for n in nivel_order],
    orientation="h",
    marker_color=[LEVEL_COLORS[n] for n in nivel_order],
))
traces = []
for nivel in nivel_order:
    pct = py_pcts[nivel]
    count = py_counts[nivel]
    traces.append(go.Bar(
        y=["Python"],
        x=[pct],
        name=nivel,
        orientation="h",
        marker_color=LEVEL_COLORS[nivel],
        text=[f"{nivel}: {pct:.0f}%"],
        textposition="inside",
        textfont=dict(color=WHITE if nivel in ["Intermedio", "Avanzado"] else DARK_GRAY, size=13),
        hovertemplate=f"{nivel}: {count} personas ({pct:.0f}%)<extra></extra>",
    ))
fig = go.Figure(data=traces)
_ = fig.update_layout(
    barmode="stack",
    legend=dict(orientation="h", y=-0.3, x=0.5, xanchor="center"),
    yaxis=dict(showticklabels=False),
)
_ = fig.update_xaxes(showgrid=False, showticklabels=False, range=[0, 100])
hackods_fig(fig)
```

### Quarto

```{python}
#| title: "Nivel de Quarto"
q_counts = df["quarto_nivel"].value_counts().reindex(nivel_order, fill_value=0)
q_pcts = q_counts / N * 100

traces = []
for nivel in nivel_order:
    pct = q_pcts[nivel]
    count = q_counts[nivel]
    traces.append(go.Bar(
        y=["Quarto"],
        x=[pct],
        name=nivel,
        orientation="h",
        marker_color=LEVEL_COLORS[nivel],
        text=[f"{nivel}: {pct:.0f}%"],
        textposition="inside",
        textfont=dict(color=WHITE if nivel in ["Intermedio", "Avanzado"] else DARK_GRAY, size=13),
        hovertemplate=f"{nivel}: {count} personas ({pct:.0f}%)<extra></extra>",
    ))
fig = go.Figure(data=traces)
_ = fig.update_layout(
    barmode="stack",
    legend=dict(orientation="h", y=-0.3, x=0.5, xanchor="center"),
    yaxis=dict(showticklabels=False),
)
_ = fig.update_xaxes(showgrid=False, showticklabels=False, range=[0, 100])
hackods_fig(fig)
```

### GitHub Pages

```{python}
#| title: "Nivel de GitHub Pages"
gh_counts = df["github_nivel"].value_counts().reindex(nivel_order, fill_value=0)
gh_pcts = gh_counts / N * 100

traces = []
for nivel in nivel_order:
    pct = gh_pcts[nivel]
    count = gh_counts[nivel]
    traces.append(go.Bar(
        y=["GitHub Pages"],
        x=[pct],
        name=nivel,
        orientation="h",
        marker_color=LEVEL_COLORS[nivel],
        text=[f"{nivel}: {pct:.0f}%"],
        textposition="inside",
        textfont=dict(color=WHITE if nivel in ["Intermedio", "Avanzado"] else DARK_GRAY, size=13),
        hovertemplate=f"{nivel}: {count} personas ({pct:.0f}%)<extra></extra>",
    ))
fig = go.Figure(data=traces)
_ = fig.update_layout(
    barmode="stack",
    legend=dict(orientation="h", y=-0.3, x=0.5, xanchor="center"),
    yaxis=dict(showticklabels=False),
)
_ = fig.update_xaxes(showgrid=False, showticklabels=False, range=[0, 100])
hackods_fig(fig)
```

# Nuestro planeta

## Row {.tabset .fill}

### Totales

```{python}
#| content: valuebox
#| title: "ODS mas votado"
ods_top = df["ods_favorito"].value_counts().index[0]
dict(icon="globe2", color=SDG_COLORS[ods_top], value=f"ODS {ods_top}: {SDG_NAMES[ods_top]}")
```

```{python}
#| content: valuebox
#| title: "Reciclan"
all_habitos = [h for persona in habitos_por_persona for h in persona]
pct_recicla = sum(1 for p in habitos_por_persona if "Recicla" in p) / N * 100
dict(icon="recycle", color="#4CA146", value=f"{pct_recicla:.0f}%")
```

```{python}
#| content: valuebox
#| title: "Conocen su huella CO2"
pct_huella = ((df["conciencia_carbono"] == "Si, calculo mi huella") | (df["conciencia_carbono"] == "Tengo una idea general")).mean() * 100
dict(icon="cloud-fill", color="#0a97d9", value=f"{pct_huella:.0f}%")
```

```{python}
#| content: valuebox
#| title: "Habitos sostenibles (prom.)"
avg_habitos = np.mean([len(h) for h in habitos_por_persona])
dict(icon="tree-fill", color="#59BA48", value=f"{avg_habitos:.1f}")
```

### ODS favoritos

```{python}
#| title: "Que ODS nos importa mas?"
ods_counts = df["ods_favorito"].value_counts().sort_index().reset_index()
ods_counts.columns = ["ods", "votos"]
ods_counts["nombre"] = ods_counts["ods"].map(lambda x: f"ODS {x}: {SDG_NAMES[x]}")
ods_counts["color"] = ods_counts["ods"].map(SDG_COLORS)

fig = go.Figure(go.Treemap(
    labels=ods_counts["nombre"],
    parents=[""] * len(ods_counts),
    values=ods_counts["votos"],
    marker_colors=ods_counts["color"],
    textinfo="label+value",
    textfont=dict(size=13, color=WHITE),
    hovertemplate="<b>%{label}</b><br>%{value} votos<extra></extra>",
))
hackods_fig(fig)
```

### Habitos sostenibles

```{python}
#| title: "Que hacemos por el planeta?"
from collections import Counter
habitos_flat = Counter(all_habitos)
hab_df = pd.DataFrame(habitos_flat.items(), columns=["habito", "count"]).sort_values("count", ascending=False)

fig = go.Figure(go.Treemap(
    labels=hab_df["habito"],
    parents=[""] * len(hab_df),
    values=hab_df["count"],
    marker_colors=HACKODS_CAT[:len(hab_df)],
    textinfo="label+value",
    textfont=dict(size=13, color=WHITE),
    hovertemplate="<b>%{label}</b><br>%{value} personas<extra></extra>",
))
hackods_fig(fig)
```

### Huella de carbono

```{python}
#| title: "Conoces tu huella de carbono?"
carb_counts = df["conciencia_carbono"].value_counts().reset_index()
carb_counts.columns = ["nivel", "count"]
carb_colors = ["#01579b", "#0a97d9", "#7dd3f7", "#e5e7eb"]

fig = go.Figure(go.Treemap(
    labels=carb_counts["nivel"],
    parents=[""] * len(carb_counts),
    values=carb_counts["count"],
    marker_colors=carb_colors[:len(carb_counts)],
    textinfo="label+value",
    textfont=dict(size=13, color=WHITE),
    hovertemplate="<b>%{label}</b><br>%{value} personas<extra></extra>",
))
hackods_fig(fig)
```

### Acciones climaticas

```{python}
#| title: "Que acciones tomamos?"
acc_counts = df["accion_climatica"].value_counts().reset_index()
acc_counts.columns = ["accion", "count"]

fig = go.Figure(go.Treemap(
    labels=acc_counts["accion"],
    parents=[""] * len(acc_counts),
    values=acc_counts["count"],
    marker_colors=HACKODS_CAT[:len(acc_counts)],
    textinfo="label+value",
    textfont=dict(size=13, color=WHITE),
    hovertemplate="<b>%{label}</b><br>%{value} personas<extra></extra>",
))
hackods_fig(fig)
```

# El lado humano

## Row {.tabset .fill}

### Totales

```{python}
#| content: valuebox
#| title: "Horas de sueno (prom.)"
dict(icon="moon-stars-fill", color="#126A9F", value=f"{df['horas_sueno'].mean():.1f} hrs")
```

```{python}
#| content: valuebox
#| title: "Snack #1"
dict(icon="cup-hot-fill", color="#E5233D", value=df["snack"].value_counts().index[0])
```

```{python}
#| content: valuebox
#| title: "Animal espiritu #1"
dict(icon="bug-fill", color="#4CA146", value=df["animal_espiritu"].value_counts().index[0])
```

```{python}
#| content: valuebox
#| title: "Superpoder #1"
dict(icon="lightning-charge-fill", color="#F26A2D", value=df["superpoder"].value_counts().index[0])
```

### Musica para hackear

```{python}
#| title: "Que escuchamos?"
music_counts = df["genero_musical"].value_counts()
pull_vals = [0.05 if i == 0 else 0 for i in range(len(music_counts))]

fig = go.Figure(go.Pie(
    labels=music_counts.index,
    values=music_counts.values,
    hole=0.5,
    pull=pull_vals,
    marker_colors=HACKODS_CAT[:len(music_counts)],
    textinfo="label+percent",
    textfont=dict(size=12),
    hovertemplate="%{label}: %{value} personas (%{percent})<extra></extra>",
))
_ = fig.add_annotation(text=f"<b>{N}</b><br>playlists", x=0.5, y=0.5,
                   font=dict(size=16, family=TITLE_FONT, color=BLACK),
                   showarrow=False)
hackods_fig(fig)
```

### Animal espiritu

```{python}
#| title: "Cual es tu animal en reuniones?"
animal_counts = df["animal_espiritu"].value_counts().sort_values()
animal_labels = [animal_emojis.get(a, a) for a in animal_counts.index]
bar_colors = [HACKODS_CAT[i % len(HACKODS_CAT)] for i in range(len(animal_counts))]

fig = go.Figure(go.Bar(
    y=animal_labels,
    x=animal_counts.values,
    orientation="h",
    marker_color=bar_colors,
    text=animal_counts.values,
    textposition="outside",
    hovertemplate="%{y}: %{x} votos<extra></extra>",
))
_ = fig.update_xaxes(showgrid=False, showticklabels=False)
_ = fig.update_yaxes(showgrid=False)
hackods_fig(fig)
```

### Snacks del hackathon

```{python}
#| title: "Que comemos mientras codeamos?"
snack_counts = df["snack"].value_counts().reset_index()
snack_counts.columns = ["snack", "count"]

fig = go.Figure(go.Treemap(
    labels=snack_counts["snack"],
    parents=[""] * len(snack_counts),
    values=snack_counts["count"],
    marker_colors=HACKODS_CAT[:len(snack_counts)],
    textinfo="label+value",
    hovertemplate="<b>%{label}</b><br>%{value} personas<extra></extra>",
))
hackods_fig(fig)
```

### Horas de sueno

```{python}
#| title: "Cuanto dormimos?"
fig = go.Figure(go.Histogram(
    x=df["horas_sueno"],
    nbinsx=10,
    marker_color=ODS_BLUE,
    opacity=0.85,
    hovertemplate="~%{x} hrs: %{y} personas<extra></extra>",
))
mean_sleep = df["horas_sueno"].mean()
_ = fig.add_vline(x=mean_sleep, line_dash="dash", line_color=BLACK, line_width=2)
_ = fig.add_annotation(text=f"Promedio: {mean_sleep:.1f} hrs", x=mean_sleep + 0.8, y=0.95,
                   yref="paper", showarrow=False,
                   font=dict(size=13, color=BLACK, family=TITLE_FONT))
_ = fig.add_annotation(text="Zombies", x=1.5, y=0.85, yref="paper",
                   showarrow=False, font=dict(size=11, color=MEDIUM_GRAY))
_ = fig.add_annotation(text="Duermen como bebes", x=7.5, y=0.85, yref="paper",
                   showarrow=False, font=dict(size=11, color=MEDIUM_GRAY))
_ = fig.update_xaxes(title_text="Horas", showgrid=False)
_ = fig.update_yaxes(title_text="Participantes", showgrid=True, gridcolor="#f3f4f6")
hackods_fig(fig)
```

### Superpoderes

```{python}
#| title: "Que superpoder querrias?"
sp_counts = df["superpoder"].value_counts().sort_values()
fig = go.Figure(go.Bar(
    y=sp_counts.index,
    x=sp_counts.values,
    orientation="h",
    marker_color=ODS_BLUE,
    text=sp_counts.values,
    textposition="outside",
    hovertemplate="%{y}: %{x} votos<extra></extra>",
))
_ = fig.update_xaxes(showgrid=False, showticklabels=False)
_ = fig.update_yaxes(showgrid=False)
hackods_fig(fig)
```
